---
title: "量化交易入门指南：第13天 - 组合回测与策略评估基础"
date: 2025-06-27
draft: false
description: "量化交易学习系列第13天：系统讲解回测系统的基本结构与流程，组合收益、波动率、夏普比率、最大回撤的计算方法，常见评估指标与Python实战，帮助你掌握量化策略从理论到验证的关键环节。"
tags: ["量化交易", "回测系统", "策略评估", "夏普比率", "最大回撤", "Python实战"]
categories: ["量化交易"]
author: "徐亚飞"
showToc: true
TocOpen: true
weight: 18
---

# 量化交易入门指南：第13天 - 组合回测与策略评估基础

**学习时间：60分钟**

> 本文为量化交易学习系列第13天内容，系统讲解回测系统的基本结构与流程，组合收益、波动率、夏普比率、最大回撤的计算方法，常见评估指标与Python实战，帮助你掌握量化策略从理论到验证的关键环节。

---

## Day 13 学习目标

你将掌握：
1. 回测系统的基本结构与流程
2. 组合收益、波动率、夏普比率、最大回撤的计算方法
3. 常见的组合评估指标与解释
4. 实现一个简易组合回测脚本（支持多期滚动回测）
5. 初步了解换手率与滑点对策略性能的影响

---

## 一、回测系统概述

### 1.1 什么是回测？

回测（Backtesting）是量化投资中极其核心的概念。我们可以把它简单理解为：

**"用历史数据模拟策略在过去会产生什么样的表现。"**

换句话说：你把自己构建的选股逻辑、交易信号、资产配置方法"放回过去"，看它是否真的能赚钱、表现是否稳定、风险是否可控。

### 1.2 为什么要做回测？

因为我们无法直接用真实资金去试错。

回测是一个安全的、低成本的实验室。它帮助我们回答以下关键问题：

| 关键问题 | 回测提供答案 |
|----------|--------------|
| 这套策略过去有效吗？ | 收益、波动、回撤等指标 |
| 有哪些历史阶段策略表现不好？ | 市场分析、鲁棒性验证 |
| 策略是否稳定？未来是否还能用？ | 多期、多市场测试 |
| 策略换手率、交易频率高吗？ | 交易成本模拟 |
| 模型是否存在未来信息泄露？ | 因果关系检查（滚动回测） |

---

## 二、回测系统的基本流程

### 2.1 回测流程详解

以选股策略为例，回测的流程可以分为以下步骤：

**Step 1️⃣：输入数据（历史行情和财务数据）**

你需要以下内容：
- 股票历史价格（日线/月线）
- 财务指标（如 PE、ROE、PB）
- 其他辅助数据（行业、市值、波动率等）

**Step 2️⃣：构建因子 / 模型信号**

比如你定义一个因子：
```
打分 = -PE + ROE + Momentum
```
或者用机器学习预测未来收益。

**Step 3️⃣：按调仓周期选股**

例如每个月：
- 计算因子得分
- 选出前20名股票
- 等权买入或按打分分配权重

**Step 4️⃣：计算下一个周期的实际收益**

假设你在 2022-01 调仓，那么你要记录 2022-01 → 2022-02 期间这些股票的实际涨跌幅，用来评估组合收益。

**Step 5️⃣：滚动这一流程直到回测结束**

一般会设一个回测窗口（如3年、5年、10年），每期都重复：
- 选股 → 持仓 → 计算收益 → 累计收益

**Step 6️⃣：输出策略表现指标**

你将得到这些核心结果：

| 指标 | 说明 |
|------|------|
| 年化收益 | 策略的长期赚钱能力 |
| 年化波动率 | 策略的风险水平 |
| 夏普比率 | 每单位风险带来的收益 |
| 最大回撤 | 最大亏损幅度，衡量极端风险 |
| 收益曲线 | 累计净值随时间变化情况 |
| 换手率 | 交易频率，影响实盘成本 |

---

### 2.2 回测示例

**举个直观的例子：**

假设你要回测策略：
"每月买入市盈率最低的10只股票，持有1个月后再更新组合。"

你会怎么做？
1. 从2018年开始，每月计算全部股票的PE
2. 选出PE最低的10只股票
3. 查看这10只股票在下月的实际收益
4. 记录组合平均收益
5. 累积净值曲线
6. 得出这套策略在2018-2023年的表现，看看是否稳定赚钱

这就是一次完整的回测。

---

### 2.3 回测注意事项

| 问题 | 说明 |
|------|------|
| 未来函数问题 | 不能使用未来的信息，比如"未来的收益"来排序 |
| 数据对齐 | 财报发布日期、涨停停牌等需要考虑 |
| 交易规则 | 要考虑滑点、手续费、买入限制等 |
| 并非收益越高越好 | 要考虑最大回撤、夏普比率等整体表现 |

**回测 ≠ 实盘**

回测表现好，不代表实盘能赚钱。

回测只是第一步，它只能回答："在已知的历史数据中，这个策略表现如何？"

如果你在回测中过拟合（调参太多、使用过多假设），实盘可能根本跑不出来。

所以我们通常还会做：
- 样本外验证（测试模型在未参与训练的数据上是否有效）
- 蒙特卡洛模拟（引入随机扰动评估稳定性）
- 实盘监控（Paper trading 或小资金试跑）

**小结一句话：**
回测是量化策略的"模拟实验室"，用历史来检验模型是否有望在未来赚钱。

---

## 三、关键回测评估指标

### 3.1 核心指标计算公式

| 指标 | 公式 | 含义 |
|------|------|------|
| 年化收益率 | $\text{CAGR} = \left(\frac{V_T}{V_0}\right)^{1/n} - 1$ | 表现强弱 |
| 年化波动率 | $\sigma \cdot \sqrt{N}$ | 风险水平 |
| 夏普比率 | $\frac{R_p - R_f}{\sigma}$ | 单位风险收益 |
| 最大回撤 | $\max(\text{Peak} - \text{Trough}) / \text{Peak}$ | 下行风险 |
| 换手率 | $\sum(\text{新权重} - \text{旧权重})$   | 交易频率 |

### 3.2 指标详解

**年化收益率（CAGR）：**
$$
\text{CAGR} = \left(\frac{V_T}{V_0}\right)^{1/n} - 1
$$
其中 $V_T$ 是期末净值，$V_0$ 是期初净值，$n$ 是年数。

**年化波动率：**
$$
\sigma_{\text{年化}} = \sigma_{\text{月}} \times \sqrt{12}
$$
或
$$
\sigma_{\text{年化}} = \sigma_{\text{日}} \times \sqrt{252}
$$

**夏普比率：**
$$
\text{Sharpe Ratio} = \frac{R_p - R_f}{\sigma_p}
$$
其中 $R_p$ 是组合收益率，$R_f$ 是无风险利率，$\sigma_p$ 是组合波动率。

**最大回撤：**
$$
\text{Max Drawdown} = \max_{t \in [0,T]} \left(\frac{P_t - P_{\max(t)}}{P_{\max(t)}}\right)
$$

---

## 四、回测注意事项

### 4.1 滚动回测的重要性

**为什么要采用滚动回测，而不是整段数据一次性测试？**

因为滚动回测更接近真实交易逻辑，能有效避免"未来函数"，减少过拟合，更真实地模拟策略在不同市场环境下的表现。

| 回测方式 | 特点 | 问题 |
|----------|------|------|
| 整段回测 | 一次性用全部数据构建模型 | 容易"泄露未来"信息，例如用未来收益训练今天的模型 |
| 滚动回测 | 每期只用历史数据构建因子/模型，滚动选股调仓 | 更贴近实盘交易节奏，评估因子和组合的稳定性与泛化能力 |

滚动回测强调因子"实时构建 + 实时调仓 + 延迟验证"，这是量化研究必须遵循的"时间因果性"。

### 4.2 策略鲁棒性评估

**如果回测期间出现极端市场事件（如熔断、黑天鹅），你的策略是否鲁棒？**

只有在极端事件下表现仍可控、不会连续大幅亏损的策略，才算鲁棒。鲁棒性需要依赖于：风控机制、风险敞口控制、多元资产配置等。

**判断一个策略是否鲁棒：**

| 指标/现象 | 说明 |
|-----------|------|
| 最大回撤 | 是否能在极端行情下控制在可承受范围？（如 < 20%） |
| 收益曲线平滑性 | 是否会突然暴跌、短期内亏损回不来？ |
| 杠杆风险 | 杠杆策略是否有"爆仓"风险 |
| 冷启动稳定性 | 起始期选得不好，策略是否仍能回升？ |
| 多市场泛化能力 | 是否能在不同市场也有效？避免"单市场依赖" |

你可以通过"事件样本内"和"样本外窗口"分别评估策略表现，如 2020年3月（新冠熔断）或 2015年（股灾）。

### 4.3 换手率控制

**换手率过高会带来哪些实盘问题？如何做低换手率策略？**

| 问题 | 说明 |
|------|------|
| 成本上升 | 手续费、印花税、滑点等迅速吞噬利润 |
| 流动性风险 | 频繁交易可能踩中低流动性股票，导致冲击成本 |
| 模型不稳定 | 高频调仓易受短期波动干扰，鲁棒性差 |
| 实施难度 | 需要频繁运行交易系统，执行复杂 |

**降低换手率的策略：**

| 方法 | 原理 |
|------|------|
| 得分惯性保留 | 上期 Top 股票保持持仓，除非得分下滑严重 |
| 排名窗口控制 | 只换出最低分 X% 的股票，保留其余 |
| 调仓周期延长 | 周调仓 → 月调仓；月调仓 → 季调仓 |
| 滚动组合 | 每期只更换一部分股票，渐进更新组合 |

### 4.4 极端风险指标

**哪些评估指标对"极端亏损"最敏感？如何应对？**

| 指标 | 敏感度 | 意义 |
|------|--------|------|
| 最大回撤（Max Drawdown） | 极高 | 衡量投资组合从峰值到谷底的最大跌幅 |
| Calmar Ratio | 高 | 年化收益 / 最大回撤，稳定性的重要衡量标准 |
| Sortino Ratio | 高 | 类似 Sharpe，但只关注"下行波动" |
| 年化收益 | 低 | 平均值不反映极端亏损影响 |
| IC、IR | 很低 | 是因子层指标，不一定反映组合极端行为 |

**如何应对极端亏损风险：**

| 方法 | 原理 |
|------|------|
| 设置止损线 | 超过某一回撤阈值清仓或减仓 |
| 组合分散化 | 多行业、多资产、低相关性组合 |
| 波动率控制 | 动态调整仓位，使风险暴露恒定 |
| 极端事件回测 | 在历史熔断、金融危机时期回测表现（如2008/2015/2020） |
| Tail Risk 对冲 | 加入期权、黄金、波动率指数等对冲工具 |

---

## 五、Python 实战：简易组合回测

我们用 Pandas 模拟一个简单月度回测（选股 + 均权 + 收益累加）

### 5.1 数据准备

```python
import pandas as pd
import numpy as np

# 假设我们有 3 期数据，每期包含股票因子与未来1期收益
data = pd.DataFrame({
    'date': ['2023-01', '2023-01', '2023-01', '2023-02', '2023-02', '2023-02', '2023-03', '2023-03', '2023-03'],
    'stock': ['A', 'B', 'C'] * 3,
    'factor': [0.5, 0.2, 0.1, 0.4, 0.3, 0.2, 0.3, 0.1, 0.6],
    'next_ret': [0.03, -0.01, 0.02, 0.02, -0.005, 0.01, 0.015, 0.03, -0.01]
})

print("原始数据：")
print(data)
```

### 5.2 简单策略回测

```python
# 简单策略：每期选前2因子 → 等权持有 → 计算组合收益
results = []
dates = data['date'].unique()

for dt in dates:
    df = data[data['date'] == dt].copy()
    df = df.sort_values('factor', ascending=False).head(2)  # Top 2
    ret = df['next_ret'].mean()  # 等权组合收益
    results.append({'date': dt, 'ret': ret})

returns_df = pd.DataFrame(results)
returns_df['cum_return'] = (1 + returns_df['ret']).cumprod()

print("\n回测结果：")
print(returns_df)
```

### 5.3 评估指标计算

```python
# 评估指标计算
monthly_returns = returns_df['ret']

# 年化收益率（假设月度）
cagr = (returns_df['cum_return'].iloc[-1])**(1/len(returns_df)) - 1

# 年化波动率
vol = np.std(monthly_returns) * np.sqrt(12)

# 夏普比率（假设无风险利率为0）
sharpe = (monthly_returns.mean() * 12) / vol

# 最大回撤
cummax = returns_df['cum_return'].cummax()
drawdown = (cummax - returns_df['cum_return']) / cummax
max_drawdown = drawdown.max()

print(f"\n=== 策略评估指标 ===")
print(f"年化收益率: {cagr:.2%}")
print(f"年化波动率: {vol:.2%}")
print(f"夏普比率: {sharpe:.2f}")
print(f"最大回撤: {max_drawdown:.2%}")
```

### 5.4 完整回测框架

```python
class SimpleBacktest:
    def __init__(self, data, top_n=2):
        self.data = data
        self.top_n = top_n
        self.results = []
        
    def run_backtest(self):
        """运行回测"""
        dates = self.data['date'].unique()
        
        for dt in dates:
            # 当期数据
            df = self.data[self.data['date'] == dt].copy()
            
            # 选股（按因子排序选前N名）
            selected = df.sort_values('factor', ascending=False).head(self.top_n)
            
            # 计算组合收益（等权）
            portfolio_ret = selected['next_ret'].mean()
            
            # 记录结果
            self.results.append({
                'date': dt,
                'portfolio_ret': portfolio_ret,
                'selected_stocks': list(selected['stock'])
            })
        
        return pd.DataFrame(self.results)
    
    def calculate_metrics(self, returns_df):
        """计算评估指标"""
        monthly_returns = returns_df['portfolio_ret']
        
        # 累计收益
        returns_df['cum_return'] = (1 + monthly_returns).cumprod()
        
        # 年化收益率
        cagr = (returns_df['cum_return'].iloc[-1])**(1/len(returns_df)) - 1
        
        # 年化波动率
        vol = np.std(monthly_returns) * np.sqrt(12)
        
        # 夏普比率
        sharpe = (monthly_returns.mean() * 12) / vol if vol > 0 else 0
        
        # 最大回撤
        cummax = returns_df['cum_return'].cummax()
        drawdown = (cummax - returns_df['cum_return']) / cummax
        max_drawdown = drawdown.max()
        
        return {
            'cagr': cagr,
            'volatility': vol,
            'sharpe': sharpe,
            'max_drawdown': max_drawdown
        }

# 使用示例
backtest = SimpleBacktest(data, top_n=2)
results = backtest.run_backtest()
metrics = backtest.calculate_metrics(results)

print("\n=== 完整回测结果 ===")
print(results)
print(f"\n=== 评估指标 ===")
for key, value in metrics.items():
    if key == 'cagr' or key == 'volatility' or key == 'max_drawdown':
        print(f"{key}: {value:.2%}")
    else:
        print(f"{key}: {value:.2f}")
```

**示例输出可能为：**
```
年化收益率: 11.84%
年化波动率: 7.22%
夏普比率: 1.64
最大回撤: 3.12%
```

说明策略在简化环境下有不错的收益-风险比。

---

## 六、思考题与解答

### 6.1 为什么要采用滚动回测，而不是整段数据一次性测试？

**答案：** 因为滚动回测更接近真实交易逻辑，能有效避免"未来函数"，减少过拟合，更真实地模拟策略在不同市场环境下的表现。

**解释：**
- 整段回测容易"泄露未来"信息，例如用未来收益训练今天的模型
- 滚动回测更贴近实盘交易节奏，评估因子和组合的稳定性与泛化能力
- 滚动回测强调因子"实时构建 + 实时调仓 + 延迟验证"
- 这是量化研究必须遵循的"时间因果性"

---

### 6.2 如果回测期间出现极端市场事件（如熔断、黑天鹅），你的策略是否鲁棒？

**答案：** 只有在极端事件下表现仍可控、不会连续大幅亏损的策略，才算鲁棒。鲁棒性需要依赖于：风控机制、风险敞口控制、多元资产配置等。

**判断一个策略是否鲁棒：**
- 最大回撤是否能在极端行情下控制在可承受范围？（如 < 20%）
- 收益曲线是否平滑，不会突然暴跌？
- 杠杆策略是否有"爆仓"风险？
- 起始期选得不好，策略是否仍能回升？
- 是否能在不同市场也有效？避免"单市场依赖"

你可以通过"事件样本内"和"样本外窗口"分别评估策略表现，如 2020年3月（新冠熔断）或 2015年（股灾）。

---

### 6.3 换手率过高会带来哪些实盘问题？如何做低换手率策略？

**答案：** 高换手率会导致成本上升、流动性风险、模型不稳定、实施难度增加等问题。

**降低换手率的策略：**
- 得分惯性保留：上期 Top 股票保持持仓，除非得分下滑严重
- 排名窗口控制：只换出最低分 X% 的股票，保留其余
- 调仓周期延长：周调仓 → 月调仓；月调仓 → 季调仓
- 滚动组合：每期只更换一部分股票，渐进更新组合

---

### 6.4 哪些评估指标对"极端亏损"最敏感？如何应对？

**答案：** 最大回撤、Calmar Ratio、Sortino Ratio 对极端亏损最敏感。

**如何应对极端亏损风险：**
- 设置止损线：超过某一回撤阈值清仓或减仓
- 组合分散化：多行业、多资产、低相关性组合
- 波动率控制：动态调整仓位，使风险暴露恒定
- 极端事件回测：在历史熔断、金融危机时期回测表现
- Tail Risk 对冲：加入期权、黄金、波动率指数等对冲工具

---

## 七、总结回顾

| 问题 | 结论 |
|------|------|
| 为什么用滚动回测？ | 更真实、更严谨，避免未来信息泄露 |
| 策略鲁棒性的判断标准？ | 回撤可控、多期稳健、极端行情下不爆雷 |
| 高换手问题？ | 成本高、风险大、操作难，建议做控制机制 |
| 最敏感指标？ | 最大回撤、Sortino、Calmar，辅助用收益线判断 |

---

## 八、小结

| 概念 | 说明 |
|------|------|
| 回测系统 | 用历史数据模拟策略表现，验证有效性 |
| 滚动回测 | 避免未来函数，更贴近实盘交易逻辑 |
| 评估指标 | 收益、风险、稳定性、极端风险的综合衡量 |
| 鲁棒性 | 在极端市场环境下仍能稳定表现的能力 |

---

通过今天的学习，你已经掌握了量化策略回测与评估的核心技术。下一讲我们将进入"量化策略实盘部署与风险管理"的世界，敬请期待！ 
